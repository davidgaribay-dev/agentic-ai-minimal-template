# Local Development Docker Compose
# Starts only infrastructure services - run backend and frontend manually for hot reload
#
# Usage:
#   docker compose -f docker-compose-local.yml up -d
#
# Or use the setup script:
#   ./setup-local.sh

services:
  # =============================================================================
  # Core Infrastructure
  # =============================================================================

  # S3-compatible object storage for file uploads
  seaweedfs:
    image: chrislusf/seaweedfs:latest
    restart: always
    ports:
      - "8333:8333"  # S3 API
      - "9333:9333"  # Master
      - "8080:8080"  # Volume/Filer
    command: server -s3 -dir=/data
    volumes:
      - seaweedfs-data:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:9333/cluster/status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Main application database (with pgvector for LangGraph memory semantic search)
  # Also stores audit logs and application logs
  db:
    image: pgvector/pgvector:pg17
    restart: always
    volumes:
      - app-db-data:/var/lib/postgresql/data/pgdata
    env_file:
      - ./backend/.env
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-app}"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

volumes:
  app-db-data:
  seaweedfs-data:
